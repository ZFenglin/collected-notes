# [回收机制](https://juejin.cn/post/6981588276356317214)

[回收机制-思维导图](./mind/06-回收机制.html)

## 垃圾回收机制

Garbage Collection（GC），在引擎内部工作负责垃圾回收的机制

### 垃圾对象

1. 内存管理是自动的
2. 不再被引用并且不能从根上访问到的对象就是垃圾对象

#### 垃圾对象产生

1. 对象的引用更换或者设置null
2. 默认的存在堆内存中的数据就是需要回收的无效垃圾

## 回收策略

### 标记清除算法（优先策略）

#### 启动

1. 空间中对象超过限制
2. 空间不能保证新生代中的对象移动到老生代中

#### 处理

1. 遍历所有对象标记活动对象
2. 遍历所有对象清理未标记对象
3. 销毁并回收它们所占用的内存空间

#### 缺点

1. 内存碎片化（利用标记压缩算法）
2. 分配速度慢，因为需要遍历全部对象至最低端
3. 不会立即回收对象

##### 标记压缩算法

###### 启动

1. 清除对象后会造成堆内存出现碎片
2. 碎片超过一定限制后会启动

###### 处理

1. 活的对象向一端移动
2. 清理内存后面失活的对象

### 引用计数算法

#### 处理

1. 声明了一个变量并且将一个引用类型赋值给该变量的时候这个值的引用次数就为 1
2. 如果同一个值又被赋给另一个变量，那么引用数加 1
3. 如果该变量的值被其他的值覆盖了，则引用次数减 1
4. 垃圾回收器会在运行的时候清理掉引用次数为 0 的值占用的内存

#### 特点

##### 优点

1. 发现垃圾立即回收
2. 最大限度减少程序暂停

##### 缺点

1. 循环引用（对象A有一个属性指向对象B，而对象B也具有属性引用了对象 A，引用数都是2，导致无法清除）
2. 时间开销大

## [V8回收方式](https://juejin.cn/post/6844904016325902344#heading-4)

### v8内存设限

1. 64位不超过1.5g
2. 32位不超过800mb

### 内存分配

1. V8在内存中开辟了两个空间，专门处理新生代和老生代算法
2. 小空间存储新生代（32M|16M）
3. 大空间存放老生代（64位1.4G|32位700M）

### 新生代算法（处理生存时间短对象）

1. 内存分成两个空间
   1. 对象区域
   2. 空闲区域
2. 对象区域充满启动

#### 处理过程

1. 存活对象复制到空闲区域中
2. 清理对象区域剩余对象
3. 两个空间角色对调

### 晋升

1. 新生代变量多次回收后仍存在，则晋升至老生代内存中
2. To空间使用率超过25%的对象

### 老生代算法（处理晋升对象）

1. 标记清除算法
2. 标记压缩算法
3. 标记增量
   1. 执行垃圾清理算法时，会间断执行算法
   2. 将标记分为多段进行执行，标记完，在进行清除

## 内存分析

### 内存问题

1. 内存泄露：内存使用持续升高
2. 内存膨胀：多数设备存在性能问题
3. 频繁垃圾回收：内存变化图查看

#### 造成的问题

1. 页面出现延迟加载和经常性暂停
2. 页面持续性出现糟糕的性能
3. 时间越长越来越差

### 检查内存方式

#### 浏览器任务管理器

浏览器任务管理器会显示内存和JavaScript内存

##### 内存

1. 原生内存
2. DOM节点占据内存

##### JavaScript内存

对象占据内存

#### TimeLine时序图记录（Performance工具）

1. 浏览器打开目标网址
2. 进入开发人员工具面板，选择性能
3. 点击录制，访问具体页面
4. 执行用户行为，一段时间后停止录制
5. 分析界面中记录的内存信息

#### 堆快照查找分离DOM（堆快照）

开发者工具内存部分的堆快照，检查快照是否存在DOM未使用

##### 分离DOM

###### DOM分类

1. 界面元素存活在DOM树上：界面上看到的元素
2. 垃圾对象时的DOM节点：节点从当前的DOM树上进行了脱离，而且在JS代码当中也没有人在引用它
3. 分离状态的DOM节点：节点只是从 DOM 树上脱离了，但是在 JS 代码中还有人在引用它

#### 判断是否存在频繁垃圾回收

1. TimeLine时序图频繁上升下降
2. 任务管理器频繁增加减少

## 回收优化

### 影响性能原因

#### 内存泄漏

1. 全局变量的使用
2. 定时器未清除
3. 被删除的DOM元素的引用
4. 不合理的使用闭包

#### 回收频繁触发

### 优化方式

#### 无用对象设置为null加速回收

#### 减少回收触发

1. 用设置长度为0来清空数组
2. 循环函数中可以复用部分迁移到函数外部
