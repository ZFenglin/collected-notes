<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"响应式处理","c":[{"t":"ordered_list","d":2,"p":{"lines":[3,7],"start":1},"v":"","c":[{"t":"list_item","d":3,"p":{"lines":[3,4],"index":1},"v":"1. 获取data"},{"t":"list_item","d":3,"p":{"lines":[4,5],"index":2},"v":"2. data代理至vm"},{"t":"list_item","d":3,"p":{"lines":[5,6],"index":3},"v":"3. 最后调用的 observe(data, true) 就是对data进行响应式处理"}]},{"t":"fence","d":2,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">initData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">vm</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span>\n    <span class=\"token comment\">// data获取处理</span>\n    data <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_data</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span>\n        <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> vm<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>\n        data <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isPlainObject</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// proxy data on instance</span>\n    <span class=\"token keyword\">const</span> keys <span class=\"token operator\">=</span> <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">keys</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">props</span>\n    <span class=\"token keyword\">const</span> methods <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">methods</span>\n    <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> keys<span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span>\n    <span class=\"token comment\">// 代理data至vm</span>\n    <span class=\"token keyword control-flow\">while</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>props <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// props冲突报错</span>\n            <span class=\"token comment\">// ...</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isReserved</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">proxy</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">_data</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// data响应式处理</span>\n    <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">/* asRootData */</span> <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"heading","d":2,"p":{"lines":[37,38]},"v":"observe","c":[{"t":"ordered_list","d":3,"p":{"lines":[39,44],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[39,40],"index":1},"v":"1. 拦截非对象和虚拟节点"},{"t":"list_item","d":4,"p":{"lines":[40,41],"index":2},"v":"2. ob赋值","c":[{"t":"list_item","d":6,"p":{"lines":[41,42],"index":1},"v":"1. 对象存在<strong>ob</strong>，说明响应式处理过了，则ob为value的<strong>ob</strong>"},{"t":"list_item","d":6,"p":{"lines":[42,43],"index":2},"v":"2. 否则进行响应式处理，ob = new Observer(value)"}]}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value<span class=\"token punctuation\">,</span> asRootData</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 非对象和虚拟节点拦截</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> value <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">VNode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">let</span> ob\n    <span class=\"token comment\">// ob赋值</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token string\">'__ob__'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> value<span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span> <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Observer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 已经响应式处理过了</span>\n        ob <span class=\"token operator\">=</span> value<span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>\n        shouldObserve <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token operator\">!</span><span class=\"token function\">isServerRendering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">isArray</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">isPlainObject</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">isExtensible</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n        <span class=\"token operator\">!</span>value<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isVue</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 未处理，创建Observer实例处理响应式数据</span>\n        ob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Observer</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 增加vmCount计数</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>asRootData <span class=\"token operator\">&amp;&amp;</span> ob<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">vmCount</span><span class=\"token operator\">++</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword control-flow\">return</span> ob\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[73,74]},"v":"Observer","c":[{"t":"ordered_list","d":3,"p":{"lines":[75,79],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[75,76],"index":1},"v":"1. Observer是一个响应式处理类，将传入值变为响应式数据"},{"t":"list_item","d":4,"p":{"lines":[76,77],"index":2},"v":"2. 同时会对value设置<strong>ob</strong>表明为响应式处理过的"},{"t":"list_item","d":4,"p":{"lines":[77,78],"index":3},"v":"3. 并且会在内部增加dep，用于数组七个重写方法执行时使用"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Observer</span> <span class=\"token punctuation\">{</span>\n    value<span class=\"token punctuation\">;</span>\n    dep<span class=\"token punctuation\">;</span>\n    vmCount<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 属性设置</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">value</span> <span class=\"token operator\">=</span> value\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">dep</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Dep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">vmCount</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token function\">def</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> <span class=\"token string\">'__ob__'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// ob设置__ob__表示为响应式处理过了</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">isArray</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 数组响应式处理</span>\n            <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>hasProto<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// __proto__支持</span>\n                <span class=\"token function\">protoAugment</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> arrayMethods<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// 不支持__proto__，循环定义</span>\n                <span class=\"token function\">copyAugment</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> arrayMethods<span class=\"token punctuation\">,</span> arrayKeys<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">observeArray</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 对象的响应式处理</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">walk</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 对传入对象的所有属性进行响应式处理</span>\n    <span class=\"token function\">walk</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> keys <span class=\"token operator\">=</span> <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">keys</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword control-flow\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> keys<span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">defineReactive</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> keys<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 对数组的每一项进行observe处理</span>\n    <span class=\"token function\">observeArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">items</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=</span> items<span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[121,122]},"v":"数组响应式处理","c":[{"t":"ordered_list","d":3,"p":{"lines":[123,126],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[123,124],"index":1},"v":"1. 由于Object.defineProperty并不支持数组处理数组每一项的变化"},{"t":"list_item","d":4,"p":{"lines":[124,125],"index":2},"v":"2. 所以vue将数组的7个方法重写以实现响应式"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 获取原始数组原型</span>\n<span class=\"token keyword\">const</span> arrayProto <span class=\"token operator\">=</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span>\n<span class=\"token comment\">// 利用继承获取一个数组原型对象</span>\n<span class=\"token keyword module\">export</span> <span class=\"token keyword\">const</span> arrayMethods <span class=\"token operator\">=</span> <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span>arrayProto<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 七个待重写方法</span>\n<span class=\"token keyword\">const</span> methodsToPatch <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'push'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'pop'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'shift'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'unshift'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'splice'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'sort'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'reverse'</span>\n<span class=\"token punctuation\">]</span>\n<span class=\"token comment\">// 数组重写处理</span>\nmethodsToPatch<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">method</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 缓存原始方法</span>\n    <span class=\"token keyword\">const</span> original <span class=\"token operator\">=</span> arrayProto<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span>\n    <span class=\"token function\">def</span><span class=\"token punctuation\">(</span>arrayMethods<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">mutator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token spread operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 执行原始方法</span>\n        <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> original<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 获取当前的响应式对象的__ob__</span>\n        <span class=\"token keyword\">const</span> ob <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span>\n        <span class=\"token comment\">// 获取插入项列表inserted</span>\n        <span class=\"token keyword\">let</span> inserted\n        <span class=\"token keyword control-flow\">switch</span> <span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">'push'</span><span class=\"token operator\">:</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">'unshift'</span><span class=\"token operator\">:</span>\n                inserted <span class=\"token operator\">=</span> args\n                <span class=\"token keyword control-flow\">break</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">'splice'</span><span class=\"token operator\">:</span>\n                inserted <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword control-flow\">break</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 插入项响应式处理</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>inserted<span class=\"token punctuation\">)</span> ob<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">observeArray</span><span class=\"token punctuation\">(</span>inserted<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 通知更新</span>\n        ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">dep</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">notify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword control-flow\">return</span> result\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[170,171]},"v":"defineReactive原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[173,179],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[173,174],"index":1},"v":"1. 获取property，并判断是否可以配置，不可配置直接返回"},{"t":"list_item","d":4,"p":{"lines":[174,175],"index":2},"v":"2. 对当前对象的值进行响应式处理，并获取childOb"},{"t":"list_item","d":4,"p":{"lines":[175,176],"index":3},"v":"3. 响应式处理","c":[{"t":"list_item","d":6,"p":{"lines":[176,177],"index":1},"v":"1. get：执行时触发依赖收集"},{"t":"list_item","d":6,"p":{"lines":[177,178],"index":2},"v":"2. set：值变动则处理新值响应式并触发更新"}]}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">defineReactive</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">,</span> customSetter<span class=\"token punctuation\">,</span> shallow</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> dep <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Dep</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 获取property，并判断是否可以配置，不可配置直接返回</span>\n    <span class=\"token keyword\">const</span> property <span class=\"token operator\">=</span> <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getOwnPropertyDescriptor</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>property <span class=\"token operator\">&amp;&amp;</span> property<span class=\"token punctuation\">.</span><span class=\"token property-access\">configurable</span> <span class=\"token operator\">===</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 获取getter和setter</span>\n    <span class=\"token keyword\">const</span> getter <span class=\"token operator\">=</span> property <span class=\"token operator\">&amp;&amp;</span> property<span class=\"token punctuation\">.</span><span class=\"token property-access\">get</span>\n    <span class=\"token keyword\">const</span> setter <span class=\"token operator\">=</span> property <span class=\"token operator\">&amp;&amp;</span> property<span class=\"token punctuation\">.</span><span class=\"token property-access\">set</span>\n    <span class=\"token comment\">// 参数不足获取val</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>getter <span class=\"token operator\">||</span> setter<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> arguments<span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span> <span class=\"token operator\">===</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        val <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 对当前对象的值进行响应式处理，并获取childOb</span>\n    <span class=\"token keyword\">let</span> childOb <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>shallow <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 响应式处理</span>\n    <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">defineProperty</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">enumerable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">configurable</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function\">reactiveGetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// ...</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">set</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function\">reactiveSetter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">newVal</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// ...</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"heading","d":3,"p":{"lines":[210,211]},"v":"get处理","c":[{"t":"fence","d":4,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">reactiveGetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 默认getter执行</span>\n    <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> getter <span class=\"token operator\">?</span> getter<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> val\n    <span class=\"token comment\">// Dep.target存在，则进行依赖收集</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token maybe-class-name\">Dep</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">target</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        dep<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">depend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>childOb<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// value的依赖同时收集</span>\n            childOb<span class=\"token punctuation\">.</span><span class=\"token property-access\">dep</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">depend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">isArray</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">dependArray</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword control-flow\">return</span> value\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[233,234]},"v":"set处理","c":[{"t":"fence","d":4,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">reactiveSetter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">newVal</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 获取当前对象值value，并判断是否更新，未跟更新则返回</span>\n    <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> getter <span class=\"token operator\">?</span> getter<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> val\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>newVal <span class=\"token operator\">===</span> value <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>newVal <span class=\"token operator\">!==</span> newVal <span class=\"token operator\">&amp;&amp;</span> value <span class=\"token operator\">!==</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>getter <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>setter<span class=\"token punctuation\">)</span> <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token comment\">// 执行赋值操作</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>setter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        setter<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> newVal<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token punctuation\">{</span>\n        val <span class=\"token operator\">=</span> newVal\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 新值的响应式处理，并更新childOb</span>\n    childOb <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>shallow <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>newVal<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 通知页面更新</span>\n    dep<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">notify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]}]})</script>
</body>
</html>
