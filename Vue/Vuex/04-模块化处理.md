# 模块化处理

## store的模块化处理

在store构建时会创建一个_modules用于收集模块

并提供以下方法对模块进行操控
1. registerModule
2. unregisterModule
3. hasModule

```JS
export class Store {
    constructor(options = {}) {
        // ...
        this._modules = new ModuleCollection(options)
        // ...
    }
    // ...
    // 注册模块
    registerModule(path, rawModule, options = {}) {
        if (typeof path === 'string') path = [path]
        this._modules.register(path, rawModule)
        installModule(this, this.state, path, this._modules.get(path), options.preserveState)
        // 重置store，去更新getter
        resetStoreVM(this, this.state)
    }
    // 取消模块注册
    unregisterModule(path) {
        if (typeof path === 'string') path = [path]
        this._modules.unregister(path)
        this._withCommit(() => {
            const parentState = getNestedState(this.state, path.slice(0, -1))
            Vue.delete(parentState, path[path.length - 1])
        })
        resetStore(this)
    }
    // 判断是否存在模块
    hasModule(path) {
        if (typeof path === 'string') path = [path]
        return this._modules.isRegistered(path)
    }
    // ...
}
```

## 常用工具函数

forEachValue在ModuleCollection和Module多次使用

```JS
export function forEachValue(obj, fn) {
    Object.keys(obj).forEach(key => fn(obj[key], key))
}
```

## ModuleCollection

在store的constructor中被使用创建_modules

```JS
export default class ModuleCollection {
    constructor(rawRootModule) {
        // 首次注册根模块，rawRootModule就是options
        this.register([], rawRootModule, false)
    }
    // ModuleCollection获取对应属性
    // ...
    // ModuleCollection更新处理
    // ...
    // ModuleCollection注册处理
    // ...
}
```

### ModuleCollection获取对应属性

```JS
// 按照路径获取模块
get(path) {
    return path.reduce((module, key) => {
        return module.getChild(key)
    }, this.root)
}
// 按照路径获取namespace
getNamespace(path) {
    let module = this.root
    return path.reduce((namespace, key) => {
        module = module.getChild(key)
        return namespace + (module.namespaced ? key + '/' : '')
    }, '')
}
```

### ModuleCollection更新处理

```JS
update(rawRootModule) {
    update([], this.root, rawRootModule)
}
```

### ModuleCollection注册处理

```JS
// 模块注册处理
register(path, rawModule, runtime = true) {
    const newModule = new Module(rawModule, runtime)
    if (path.length === 0) {
        // 根模块
        this.root = newModule
    } else {
        // 寻找父亲
        const parent = this.get(path.slice(0, -1))
        parent.addChild(path[path.length - 1], newModule)
    }
    if (rawModule.modules) {
        // 存在子模块则进行子模块的注册
        forEachValue(rawModule.modules, (rawChildModule, key) => {
            this.register(path.concat(key), rawChildModule, runtime)
        })
    }
}
// 模块取消注册处理
unregister(path) {
    const parent = this.get(path.slice(0, -1))
    const key = path[path.length - 1]
    const child = parent.getChild(key)
    if (!child) {
        return
    }
    if (!child.runtime) {
        return
    }
    parent.removeChild(key)
}
// 判断是否注册处理
isRegistered(path) {
    const parent = this.get(path.slice(0, -1))
    const key = path[path.length - 1]
    if (parent) {
        return parent.hasChild(key)
    }
    return false
}
```

## Module

处理store的modules

```JS
export default class Module {
    constructor(rawModule, runtime) {
        this.runtime = runtime
        this._children = Object.create(null)
        this._rawModule = rawModule
        const rawState = rawModule.state
        this.state = (typeof rawState === 'function' ? rawState() : rawState) || {}
    }
    // 判断是否设置namespace
    get namespaced() {
        return !!this._rawModule.namespaced
    }
    // 孩子相关方法
    // ...
    // 更新模块
    // ...
    // 遍历处理
    // ...
}
```

### Module孩子相关方法

```JS
addChild(key, module) {
    this._children[key] = module
}

removeChild(key) {
    delete this._children[key]
}

getChild(key) {
    return this._children[key]
}

hasChild(key) {
    return key in this._children
}
```

### Module更新模块

```JS
update(rawModule) {
    this._rawModule.namespaced = rawModule.namespaced
    if (rawModule.actions) {
        this._rawModule.actions = rawModule.actions
    }
    if (rawModule.mutations) {
        this._rawModule.mutations = rawModule.mutations
    }
    if (rawModule.getters) {
        this._rawModule.getters = rawModule.getters
    }
}
```

### Module遍历处理

```JS
forEachChild(fn) {
    forEachValue(this._children, fn)
}

forEachGetter(fn) {
    if (this._rawModule.getters) {
        forEachValue(this._rawModule.getters, fn)
    }
}

forEachAction(fn) {
    if (this._rawModule.actions) {
        forEachValue(this._rawModule.actions, fn)
    }
}

forEachMutation(fn) {
    if (this._rawModule.mutations) {
        forEachValue(this._rawModule.mutations, fn)
    }
}
```
