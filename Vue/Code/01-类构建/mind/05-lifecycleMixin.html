<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"lifecycleMixin","c":[{"t":"fence","d":2,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">lifecycleMixin</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token maybe-class-name\">Vue</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">_update</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">vnode<span class=\"token punctuation\">,</span> hydrating</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$forceUpdate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$destroy</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"heading","d":2,"p":{"lines":[18,19]},"v":"<code>_update</code> 原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[20,24],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[20,21],"index":1},"v":"1. vue内部使用，用于处理实例渲染更新方法"},{"t":"list_item","d":4,"p":{"lines":[21,22],"index":2},"v":"2. prevVnode是否存在决定是执行初次渲染，还是更新渲染"},{"t":"list_item","d":4,"p":{"lines":[22,23],"index":3},"v":"3. 挂载虚拟节点时，_update(_render())为挂载Vue核心"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">_update</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">vnode<span class=\"token punctuation\">,</span> hydrating</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> vm <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n    <span class=\"token keyword\">const</span> prevEl <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span>\n    <span class=\"token keyword\">const</span> prevVnode <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_vnode</span>\n    <span class=\"token comment\">// ...</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_vnode</span> <span class=\"token operator\">=</span> vnode\n    <span class=\"token comment\">// prevVnode用于判断时首次渲染还是更新渲染</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>prevVnode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// initial render 初次渲染</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span> <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">__patch__</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span><span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">,</span> hydrating<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">/* removeOnly */</span> <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// updates 更新渲染</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span> <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">__patch__</span><span class=\"token punctuation\">(</span>prevVnode<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// 更新__vue__引用</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// 父元素是高阶组件，自己变动了父元素也更新$el</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$vnode</span> <span class=\"token operator\">&amp;&amp;</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$parent</span> <span class=\"token operator\">&amp;&amp;</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$vnode</span> <span class=\"token operator\">===</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$parent</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">_vnode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$parent</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span> <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"ordered_list","d":3,"p":{"lines":[49,52],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[49,50],"index":1},"v":"1. 而执行真正执行挂载更新的是<strong>patch</strong>方法"},{"t":"list_item","d":4,"p":{"lines":[50,51],"index":2},"v":"2. patch的挂载则是在公共mount声明之前，patch相关请见编译与挂载的元素patch处理"}]}]},{"t":"heading","d":2,"p":{"lines":[52,53]},"v":"<code>$forceUpdate</code> 原理","c":[{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$forceUpdate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> vm <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_watcher</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_watcher</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[65,66]},"v":"$destroy原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[67,76],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[67,68],"index":1},"v":"1. 判断拦截重复处理"},{"t":"list_item","d":4,"p":{"lines":[68,69],"index":2},"v":"2. callHook(vm, 'beforeDestroy')"},{"t":"list_item","d":4,"p":{"lines":[69,70],"index":3},"v":"3. 从父组件中移除自身"},{"t":"list_item","d":4,"p":{"lines":[70,71],"index":4},"v":"4. 移除watcher监听"},{"t":"list_item","d":4,"p":{"lines":[71,72],"index":5},"v":"5. 渲染树清空"},{"t":"list_item","d":4,"p":{"lines":[72,73],"index":6},"v":"6. callHook(vm, 'destroyed')"},{"t":"list_item","d":4,"p":{"lines":[73,74],"index":7},"v":"7. 移除<code>$el.__vue__</code> 引用"},{"t":"list_item","d":4,"p":{"lines":[74,75],"index":8},"v":"8. 清空虚拟节点的parent"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$destroy</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> vm <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n    <span class=\"token comment\">// 拦截重复处理</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isBeingDestroyed</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">callHook</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token string\">'beforeDestroy'</span><span class=\"token punctuation\">)</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isBeingDestroyed</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token comment\">// 从父组件中移除自身</span>\n    <span class=\"token keyword\">const</span> parent <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$parent</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>parent <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>parent<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isBeingDestroyed</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">abstract</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">.</span><span class=\"token property-access\">$children</span><span class=\"token punctuation\">,</span> vm<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 移除watcher监听</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_watcher</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_watcher</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">teardown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_watchers</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span>\n    <span class=\"token keyword control-flow\">while</span> <span class=\"token punctuation\">(</span>i<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_watchers</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">teardown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// vmCount减一</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_data</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_data</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">vmCount</span><span class=\"token operator\">--</span>\n    <span class=\"token punctuation\">}</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isDestroyed</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token comment\">// 渲染树清空</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">__patch__</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_vnode</span><span class=\"token punctuation\">,</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">callHook</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token string\">'destroyed'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 移除组件监听</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">$off</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 移除 __vue__ 引用</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__vue__</span> <span class=\"token operator\">=</span> <span class=\"token keyword null nil\">null</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 清空虚拟节点的parent</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$vnode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$vnode</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">parent</span> <span class=\"token operator\">=</span> <span class=\"token keyword null nil\">null</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]})</script>
</body>
</html>
