# 浏览器安全

[浏览器安全思维导图](./mind/10-浏览器安全.html)

## 攻击种类

1. 中间人攻击
2. 跨站脚本攻击XSS
3. 跨站请求伪造CSRF
4. 网络劫持
5. iframe滥用，iframe内容第三方提供，不可控
6. 恶意第三方库，存在恶意代码，容易被攻击

## 中间人攻击

1. 针对于HTTPS进行攻击
2. 中间人分别于客户端和服务端建立联系，交换收到的数据
3. 客户端和服务端都以为通过私密连接从而直接通话，中间人可以监听和拦截修改内容

### 过程

1. 客户端发送请求到服务端，请求被中间⼈截获
2. 服务器向客户端发送公钥
3. 中间⼈截获公钥，然后⾃⼰⽣成⼀个伪造的公钥，发给客户端
4. 客户端收到伪造公钥，生成加密的hash发送给服务器
5. 中间人截获hash，用伪造公钥对应的私钥解密，获取真实hash，同时生成假hash，发送给服务器
6. 服务器用私钥解密，然后生成对称加密key，发送对称加密数据，中间人通过已有信息也能得出对称加密key，从而获取传输数据

### 处理

1. 利用数字证书校验消息源和公钥

## XSS

1. Cross Site Scripting 跨站脚本攻击
2. 注入代码攻击，通过HTML注入篡改了页面代码，执行恶意脚本

### 类型

#### 服务端漏洞

##### 存储型

常见于评论区，帖子和用户私信

攻击的前提时存储在数据库的数据，服务端会获取并拼接到HTML页面中

1. 恶意代码提交到⽬标⽹站的数据库中，例如发送评论
2. 其它用户打开评论网址，获取到存在恶意代码的评论
3. 解析HTML，并执行恶意代码

##### 反射型

常见于网页搜索

攻击的前提是URL中的参数数据，服务端会拼接到HTML页面中

1. 构建一个含有恶意代码的URL
2. 用户打开URL，会将URL恶意代码拼接到HTML中返回
3. 解析HTML，并执行恶意代码

#### 客户端漏洞 

##### DOM型

1. 构建一个含有恶意代码的URL
2. 用户打开URL，前端JS取出URL中恶意代码并执行

### 目的

1. DOS攻击：发送合理请求，占用服务器资源，从而使用户无法访问服务器
2. 获取页面的数据，如DOM、cookie、localStorage
3. 流量劫持：将链接指向某网站
4. 破坏页面结构

### 处理

#### 转义

对用户的数据输入至数据库，输出到页面进行转义

##### encodeurl

1. 对整个 url 进行编码
2. 特殊符号不编码（；/ ? : @ & = + $ , #）

##### encodeurlComponent

1. url 的组成进行个别编码
2. 特殊符号会编码

#### CSP

1. CSP 的本质是建立一个白名单
2. 告诉浏览器哪些外部资源可以加载和执行，防止恶意代码注入

#### httpOnly

1. cookie 使用 http-only
2. 使得脚本无法获取cookie，从而无法伪装用户进行操作

## CSRF

1. Cross Site Request Forgery 跨站请求伪造
2. 利用第三方cookie冒充用户

> 第三方cookie：第三方网站引导发出的cookie

### 类型

#### GET类型：利用img标签构建请求，进入页面自动发送请求

#### POST类型：构建一个表单，然后隐藏，用户进入页面后自动提交表单

#### 链接类型：a标签的href构建请求，诱导用户主动点击

### 处理

#### 同源检测

1. 服务器校验请求头，检查origin 或者 referer

##### 缺陷

1. referer 可以被伪造
2. 会屏蔽搜索引擎的链接

#### Token

1. 服务器向用户返回一个随机数 Token
2. 再次请求时携带token
3. 服务器对这个 token 进行验证，从而决定是否应答

##### 缺陷

1. 请求都需要携带token
2. 不支持多服务器

#### Cookie双重验证

利用了攻击者只能发送cookie，但是不能获取cookie
1. 用户访问网站页面时，向请求域名注入一个Cookie
2. 发送请求时获取cookie并添加至URL请求参数中
3. 服务器比较cookie和url参数，判断是否正确

##### 缺陷

1. XSS漏洞存在则失效
2. 无法子域名间隔离

#### [Samesite](https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html)

```
Set-Cookie: CookieName=CookieValue; SameSite=Lax;
```

##### Samesite具有以下属性

1. Strict：完全禁止第三方 Cookie，只有当前网页的 URL 与请求目标一致，才会带上 Cookie
2. Lax：链接，预加载请求，GET 表单这三种情况可以使用第三方Cookie，基本杜绝了CSRF
3. None

#### 验证码强制用户交互

## 网络劫持

### DNS劫持（输入网址a强制跳转至网址b）

1. DNS强制解析：修改本地运营商的DNS缓存记录
2. 302跳转：监控网络出口流量，劫持内容并返回302

### HTTP劫持（访问网址一直有广告）

1. 主要原因是http的明文传输，利用https可以处理
