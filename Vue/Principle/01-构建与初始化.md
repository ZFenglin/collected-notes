# 构建和初始化

## Vue构建

### GlobalAPI(Vue)

1. Vue.config
2. Vue.util
   1. warn
   2. extend
   3. mergeOptions
   4. defineReactive
3. Vue.set
4. Vue.delete
5. Vue.nextTick
6. Vue.observable
7. Vue.options
    1. components
    2. filters
    3. directive
    4. _base
8. Vue.use
9. Vue.mixin
10. Vue.extend

### Vue

#### function Vue()

1. 创建名为Vue的函数
2. 内部执行this._init方法

#### xxxMixin(Vue)

##### initMixin

1. Vue.prototype._init

##### stateMixin

1. Vue.prototype.$data
2. Vue.prototype.$props
3. Vue.prototype.$set
4. Vue.prototype.$delete
5. Vue.prototype.$watch

##### eventsMixin

1. Vue.prototype.$on
2. Vue.prototype.$once
3. Vue.prototype.$off
4. Vue.prototype.$emit

##### lifecycleMixin

1. Vue.prototype._update
2. Vue.prototype.$forceUpdate
3. Vue.prototype.$destroy

##### renderMixin

1. installRenderHelpers
   1. Vue.prototype._l
   2. Vue.prototype._t
   3. ...
2. Vue.prototype.$nextTick
3. Vue.prototype._render

## _init初始化

### 相关属性处理

1. 属性设置
   1. vm._uid = uid++
   2. vm._isVue = true
2. vm.$options = mergeOptions
   1. vm.constructor的options
   2. _init传入参数的options
3. vm._self = vm

### initXxx(vm)

1. initLifecycle
2. initEvents
3. initRender
4. callHook(vm, 'beforeCreate')
5. initInjections
6. initState
   1. vm._watchers = []
      1. 收集vm相关的所有watcher
      2. 后续$forceUpdate使用
   2. initProps
   3. initMethods
   4. initData（详见[响应式](./02-响应式.md)）
   5. initComputed和initWatch（详见[computed和watch](./05-computed与watch.md)）
7. initProvide
8. callHook(vm, 'created')

### $mount

1. 执行`vm.$mount(vm.$options.el)`
2. vm.$mount由两个mount嵌套出来
3. 外部的mount负责编译模板获得render函数，并在尾部执行内部mount
4. 内部的mount执行mountComponent进行vnode生成和挂载处理

#### 外部mount

1. 获取元素el
2. render获取（render>template>el）
   1. 存在options.render，跳过
   2. template获取
      1. options.template存在，跳过
      2. template = getOuterHTML(el)
   3. template转化为render（详见[模板编译](./06-模板编译.md)）
3. 执行内部mount

#### 内部mount

1. el获取
2. mountComponent执行
   1. vm.$options.render设为空vnode渲染函数
   2. callHook(vm, 'beforeMount')
   3. updateComponent创建
      1. vm._update(vm._render(), hydrating)
   4. Watcher创建，这个为渲染Watcher，一个Vue实例只有一个
      1. 传入vm
      2. 传入updateComponent，constructor时执行（详见[元素挂载](./07-元素挂载.md)）
      3. 传入before回调，在Watcher更新时执行 callHook(vm, 'beforeUpdate')
   5. callHook(vm, 'mounted')

#### 编译与挂载过程

1. 编译过程（外层mount）
   1. parse(template)  =>  AST
   2. optimize(AST)  =>  标记过静态节点的AST
   3. generate(标记过静态节点的AST)  =>  render函数
2. 挂载过程（内部mount）
   1. _render(render函数) =(createElement)=>  vnode
   2. _update(vnode)  =(patch)=>  真实元素
