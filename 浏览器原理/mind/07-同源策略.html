<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"同源策略","c":[{"t":"heading","d":2,"p":{"lines":[4,5]},"v":"同源策略相关概念","c":[{"t":"heading","d":3,"p":{"lines":[6,7]},"v":"跨域判断","c":[{"t":"list_item","d":5,"p":{"lines":[8,9],"index":1},"v":"1. 协议、端口号、域名必须一致"},{"t":"list_item","d":5,"p":{"lines":[9,10],"index":2},"v":"2. a.bilibili.com 和 b.bilibili.com 是不同源的"}]},{"t":"heading","d":3,"p":{"lines":[11,12]},"v":"跨域限制","c":[{"t":"heading","d":4,"p":{"lines":[13,14]},"v":"DOM元素"},{"t":"heading","d":4,"p":{"lines":[15,16]},"v":"AJAX和FETCH"},{"t":"heading","d":4,"p":{"lines":[17,18]},"v":"本地存储","c":[{"t":"list_item","d":6,"p":{"lines":[19,20],"index":1},"v":"1. cookie"},{"t":"list_item","d":6,"p":{"lines":[20,21],"index":2},"v":"2. localStorage"},{"t":"list_item","d":6,"p":{"lines":[21,22],"index":3},"v":"3. sessionStorage"},{"t":"list_item","d":6,"p":{"lines":[22,23],"index":4},"v":"4. indexDB"}]}]}]},{"t":"heading","d":2,"p":{"lines":[24,25]},"v":"cors","c":[{"t":"heading","d":3,"p":{"lines":[28,29]},"v":"相关首部字段","c":[{"t":"heading","d":4,"p":{"lines":[30,31]},"v":"请求首部字段","c":[{"t":"heading","d":5,"p":{"lines":[32,33]},"v":"Origin（必须发送）","c":[{"t":"fence","d":6,"v":"<pre><code>Origin: &lt;origin&gt;\n</code></pre>\n"}]},{"t":"heading","d":5,"p":{"lines":[42,43]},"v":"Access-Control-Request-Method","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Request-Method: &lt;method&gt;\n</code></pre>\n"}]},{"t":"heading","d":5,"p":{"lines":[50,51]},"v":"Access-Control-Request-Headers","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Request-Headers: &lt;field-name&gt;[, &lt;field-name&gt;]*\n</code></pre>\n"}]}]},{"t":"heading","d":4,"p":{"lines":[58,59]},"v":"响应首部字段","c":[{"t":"heading","d":5,"p":{"lines":[60,61]},"v":"Access-Control-Allow-Origin","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Allow-Origin: &lt;origin&gt; | *\n</code></pre>\n"}]},{"t":"heading","d":5,"p":{"lines":[68,69]},"v":"Access-Control-Allow-Credentials","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Allow-Credentials: true\n</code></pre>\n"},{"t":"ordered_list","d":6,"p":{"lines":[74,80],"start":1},"v":"","c":[{"t":"list_item","d":7,"p":{"lines":[74,75],"index":1},"v":"1. 普通响应","c":[{"t":"list_item","d":9,"p":{"lines":[75,76],"index":1},"v":"1. 是否允许浏览器读取response的内容"}]},{"t":"list_item","d":7,"p":{"lines":[76,77],"index":2},"v":"2. 预检响应","c":[{"t":"list_item","d":9,"p":{"lines":[77,78],"index":1},"v":"1. 指定了实际的请求是否可以使用credentials"},{"t":"list_item","d":9,"p":{"lines":[78,79],"index":2},"v":"2. Credentials可以为cookies, authorization headers 或 TLS client certificates"}]}]}]},{"t":"heading","d":5,"p":{"lines":[80,81]},"v":"Access-Control-Allow-Methods","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Allow-Methods: &lt;method&gt;, &lt;method&gt;, ...\n</code></pre>\n"}]},{"t":"heading","d":5,"p":{"lines":[88,89]},"v":"Access-Control-Allow-Headers","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Allow-Headers: &lt;field-name&gt;[, &lt;field-name&gt;]*\n</code></pre>\n"}]},{"t":"heading","d":5,"p":{"lines":[96,97]},"v":"Access-Control-Max-Age","c":[{"t":"fence","d":6,"v":"<pre><code>Access-Control-Max-Age: &lt;delta-seconds&gt;\n</code></pre>\n"}]}]}]},{"t":"heading","d":3,"p":{"lines":[104,105]},"v":"cors请求过程","c":[{"t":"heading","d":4,"p":{"lines":[106,107]},"v":"简单请求","c":[{"t":"ordered_list","d":5,"p":{"lines":[112,123],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[112,113],"index":1},"v":"1. 请求方法为：","c":[{"t":"list_item","d":8,"p":{"lines":[113,114],"index":1},"v":"1. GET"},{"t":"list_item","d":8,"p":{"lines":[114,115],"index":2},"v":"2. POST"},{"t":"list_item","d":8,"p":{"lines":[115,116],"index":3},"v":"3. HEAD"}]},{"t":"list_item","d":6,"p":{"lines":[116,117],"index":2},"v":"2. 信息头不超过：","c":[{"t":"list_item","d":8,"p":{"lines":[117,118],"index":1},"v":"1. Accept"},{"t":"list_item","d":8,"p":{"lines":[118,119],"index":2},"v":"2. Accept-Language"},{"t":"list_item","d":8,"p":{"lines":[119,120],"index":3},"v":"3. Content-Language"},{"t":"list_item","d":8,"p":{"lines":[120,121],"index":4},"v":"4. Last-Event-ID"},{"t":"list_item","d":8,"p":{"lines":[121,122],"index":5},"v":"5. Content-Type（值限制application/x-www-form-urlencoded，multipart/form-data和text/plain）"}]}]},{"t":"heading","d":5,"p":{"lines":[123,124]},"v":"简单请求步骤","c":[{"t":"list_item","d":7,"p":{"lines":[125,126],"index":1},"v":"1. 客户端发出CORS请求，携带Orign请求头"},{"t":"list_item","d":7,"p":{"lines":[126,127],"index":2},"v":"2. 服务器根据Orign字段判断是否同意请求，并返回相关头信息，响应头必须携带Access-Control-Allow-Origin"},{"t":"list_item","d":7,"p":{"lines":[127,128],"index":3},"v":"3. 浏览器检查响应头，缺少必要头则认为出错"}]}]},{"t":"heading","d":4,"p":{"lines":[129,130]},"v":"非简单请求","c":[{"t":"heading","d":5,"p":{"lines":[133,134]},"v":"预检请求","c":[{"t":"list_item","d":7,"p":{"lines":[135,136],"index":1},"v":"1. 发送OPTIONS请求，携带以下请求头","c":[{"t":"list_item","d":9,"p":{"lines":[136,137],"index":1},"v":"1. Orign"},{"t":"list_item","d":9,"p":{"lines":[137,138],"index":2},"v":"2. Access-Control-Request-Headers"},{"t":"list_item","d":9,"p":{"lines":[138,139],"index":3},"v":"3. Access-Control-Request-Method"}]},{"t":"list_item","d":7,"p":{"lines":[139,140],"index":2},"v":"2. 服务端按照请求头段判断，不符合报错，符合进行响应，响应头必须返回","c":[{"t":"list_item","d":9,"p":{"lines":[140,141],"index":1},"v":"1. Access-Control-Allow-Origin"},{"t":"list_item","d":9,"p":{"lines":[141,142],"index":2},"v":"2. Access-Control-Allow-Methods"},{"t":"list_item","d":9,"p":{"lines":[142,143],"index":3},"v":"3. Access-Control-Allow-Headers"}]}]},{"t":"heading","d":5,"p":{"lines":[146,147]},"v":"正式请求","c":[{"t":"list_item","d":7,"p":{"lines":[148,149],"index":1},"v":"1. 每次CORS请求都携带Origin"},{"t":"list_item","d":7,"p":{"lines":[149,150],"index":2},"v":"2. 服务端也会返回Access-Control-Allow-Origin"}]}]}]}]},{"t":"heading","d":2,"p":{"lines":[151,152]},"v":"JSONP","c":[{"t":"heading","d":3,"p":{"lines":[155,156]},"v":"JSONP实现","c":[{"t":"list_item","d":5,"p":{"lines":[157,158],"index":1},"v":"1. 利用Script标签支持跨域获取对应JS代码"},{"t":"list_item","d":5,"p":{"lines":[158,159],"index":2},"v":"2. JS代码最后调用预先注册在window的回调"}]},{"t":"heading","d":3,"p":{"lines":[160,161]},"v":"JSONP缺点","c":[{"t":"list_item","d":5,"p":{"lines":[162,163],"index":1},"v":"1. 只支持GET"},{"t":"list_item","d":5,"p":{"lines":[163,164],"index":2},"v":"2. XSS攻击"}]}]},{"t":"heading","d":2,"p":{"lines":[165,166]},"v":"代理跨域","c":[{"t":"heading","d":3,"p":{"lines":[167,168]},"v":"正向代理和反向代理","c":[{"t":"heading","d":4,"p":{"lines":[171,172]},"v":"正向代理","c":[{"t":"ordered_list","d":5,"p":{"lines":[173,177],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[173,174],"index":1},"v":"1. 正向代理其实是客户端的代理（客户端架设）"},{"t":"list_item","d":6,"p":{"lines":[174,175],"index":2},"v":"2. 客户端设置了一个代理服务器"},{"t":"list_item","d":6,"p":{"lines":[175,176],"index":3},"v":"3. 利用代理服务器去访问唯一目标服务器"}]},{"t":"heading","d":5,"p":{"lines":[177,178]},"v":"作用","c":[{"t":"list_item","d":7,"p":{"lines":[179,180],"index":1},"v":"1. 突破访问限制"},{"t":"list_item","d":7,"p":{"lines":[180,181],"index":2},"v":"2. 隐藏真实客户端"},{"t":"list_item","d":7,"p":{"lines":[181,182],"index":3},"v":"3. 提高访问速度（代理服务器缓存）"}]}]},{"t":"heading","d":4,"p":{"lines":[183,184]},"v":"反向代理","c":[{"t":"ordered_list","d":5,"p":{"lines":[185,189],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[185,186],"index":1},"v":"1. 反向代理则是服务器的代理（服务器架设）"},{"t":"list_item","d":6,"p":{"lines":[186,187],"index":2},"v":"2. 客户端访问代理服务器"},{"t":"list_item","d":6,"p":{"lines":[187,188],"index":3},"v":"3. 代理服务器指定目标服务器共客户端访问"}]},{"t":"heading","d":5,"p":{"lines":[189,190]},"v":"作用","c":[{"t":"list_item","d":7,"p":{"lines":[191,192],"index":1},"v":"1. 分担服务端负载（负载均衡）"},{"t":"list_item","d":7,"p":{"lines":[192,193],"index":2},"v":"2. 提供安全保障（代理服务器做防火墙）"},{"t":"list_item","d":7,"p":{"lines":[193,194],"index":3},"v":"3. 隐藏真实服务器"},{"t":"list_item","d":7,"p":{"lines":[194,195],"index":4},"v":"4. 提高访问速度（代理服务器缓存）"}]}]}]},{"t":"heading","d":3,"p":{"lines":[196,197]},"v":"实现方式","c":[{"t":"ordered_list","d":4,"p":{"lines":[199,202],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[199,200],"index":1},"v":"1. 将客户端请求转发至目标服务器"},{"t":"list_item","d":5,"p":{"lines":[200,201],"index":2},"v":"2. 返回值可以添加cors的响应头部处理跨域"}]},{"t":"heading","d":4,"p":{"lines":[202,203]},"v":"nginx","c":[{"t":"fence","d":5,"v":"<pre class=\"language-conf\"><code class=\"language-conf\">#proxy服务器\nserver {\n    listen       81;\n    server_name  www.domain1.com;\n    location / {\n        proxy_pass   http://www.domain2.com:8080;  #反向代理\n        proxy_cookie_domain www.domain2.com www.domain1.com; #修改cookie里域名\n        index  index.html index.htm;\n        # 当用webpack-dev-server等中间件代理接口访问nignx时，此时无浏览器参与，故没有同源限制，下面的跨域配置可不启用\n        add_header Access-Control-Allow-Origin http://www.domain1.com;  #当前端只跨域不带cookie时，可为*\n        add_header Access-Control-Allow-Credentials true;\n    }\n}\n</code></pre>\n"}]},{"t":"heading","d":4,"p":{"lines":[220,221]},"v":"nodejs 中间件（仅开发环境）","c":[{"t":"list_item","d":6,"p":{"lines":[222,223],"index":1},"v":"1. 非vue框架的跨域：node + express + http-proxy-middleware"},{"t":"list_item","d":6,"p":{"lines":[223,224],"index":2},"v":"2. vue框架：node + vue + webpack + webpack-dev-server"}]}]}]},{"t":"heading","d":2,"p":{"lines":[225,226]},"v":"WebSocket协议跨域","c":[{"t":"list_item","d":4,"p":{"lines":[227,228],"index":1},"v":"1. WebSocket protocol是HTML5一种新的协议"},{"t":"list_item","d":4,"p":{"lines":[228,229],"index":2},"v":"2. 它实现了浏览器与服务器全双工通信，同时允许跨域通讯，是server push技术的一种很好的实现"},{"t":"list_item","d":4,"p":{"lines":[229,230],"index":3},"v":"3. 推荐Socket.io，便于使用，同时向下兼容"}]},{"t":"heading","d":2,"p":{"lines":[231,232]},"v":"iframe跨域","c":[{"t":"heading","d":3,"p":{"lines":[233,234]},"v":"postMessage","c":[{"t":"heading","d":4,"p":{"lines":[235,236]},"v":"postMessage API","c":[{"t":"ordered_list","d":5,"p":{"lines":[238,242],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[238,239],"index":1},"v":"1. 页面和其打开的新窗口的数据传递"},{"t":"list_item","d":6,"p":{"lines":[239,240],"index":2},"v":"2. 多窗口之间消息传递"},{"t":"list_item","d":6,"p":{"lines":[240,241],"index":3},"v":"3. 页面与嵌套的iframe消息传递"}]},{"t":"heading","d":5,"p":{"lines":[242,243]},"v":"postMessage参数","c":[{"t":"list_item","d":7,"p":{"lines":[244,245],"index":1},"v":"1. data：任意基本类型或可复制的对象，但是最好JSON.stringify()序列化"},{"t":"list_item","d":7,"p":{"lines":[245,246],"index":2},"v":"2. origin：（协议+主机+端口号，* 任意窗口，/ 同源窗口）"}]}]},{"t":"heading","d":4,"p":{"lines":[247,248]},"v":"实现方式","c":[{"t":"list_item","d":6,"p":{"lines":[249,250],"index":1},"v":"1. 主页面利用iframe和跨域页通信"},{"t":"list_item","d":6,"p":{"lines":[250,251],"index":2},"v":"2. 两边都对message进行监听"},{"t":"list_item","d":6,"p":{"lines":[251,252],"index":3},"v":"3. 主页面利用ifame获取跨域页面iframe.contentWindow.postMessage通信"},{"t":"list_item","d":6,"p":{"lines":[252,253],"index":4},"v":"4. 跨域页利用window.parent.postMessage通信"}]}]},{"t":"heading","d":3,"p":{"lines":[254,255]},"v":"document.domain + iframe跨域","c":[{"t":"list_item","d":5,"p":{"lines":[256,257],"index":1},"v":"1. 方案仅限主域相同，子域不同的跨域应用场景"},{"t":"list_item","d":5,"p":{"lines":[257,258],"index":2},"v":"2. 实现原理：两个页面都通过js强制设置document.domain为基础主域，就实现了同域"}]},{"t":"heading","d":3,"p":{"lines":[259,260]},"v":"location.hash + iframe跨域","c":[{"t":"list_item","d":5,"p":{"lines":[261,262],"index":1},"v":"1. 实现原理：a欲与b跨域相互通信，通过中间页c来实现。"},{"t":"list_item","d":5,"p":{"lines":[262,263],"index":2},"v":"2. 三个页面，不同域之间利用iframe的location.hash传值，相同域之间直接js访问来通信"}]},{"t":"heading","d":3,"p":{"lines":[264,265]},"v":"window.name + iframe跨域","c":[{"t":"list_item","d":5,"p":{"lines":[266,267],"index":1},"v":"1. window.name属性的独特之处：name值在不同的页面（甚至不同域名）加载后依旧存在，并且可以支持非常长的 name 值（2MB）"},{"t":"list_item","d":5,"p":{"lines":[267,268],"index":2},"v":"2. a页面加载b页面，b更换name后将页面切换至a同源的proxy"}]}]}]})</script>
</body>
</html>
