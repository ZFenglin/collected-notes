<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"处理入口","c":[{"t":"ordered_list","d":2,"p":{"lines":[1,6],"start":1},"v":"","c":[{"t":"list_item","d":3,"p":{"lines":[1,2],"index":1},"v":"1. vue的_init结尾触发<code>vm.$mount(vm.$options.el)</code>，开始进行模板编译和元素挂载"},{"t":"list_item","d":3,"p":{"lines":[2,3],"index":2},"v":"2. <code>Vue.prototype.$mount</code>处理元素的创建和挂载，同时vue将其拆分成两个","c":[{"t":"list_item","d":5,"p":{"lines":[3,4],"index":1},"v":"1. 模板解析和render函数获取的外层mount"},{"t":"list_item","d":5,"p":{"lines":[4,5],"index":2},"v":"2. 负责执行元素创建和挂载的内部mount"}]}]},{"t":"heading","d":2,"p":{"lines":[6,7]},"v":"执行过程","c":[{"t":"list_item","d":4,"p":{"lines":[8,9],"index":1},"v":"1. 编译过程（外层mount）：template =(parse)=&gt; AST =(generate)=&gt; 获取render"},{"t":"list_item","d":4,"p":{"lines":[9,10],"index":2},"v":"2. 挂载过程（内部mount）：执行_render =(createElement)=&gt; vnode =&gt; 执行_update =(patch)=&gt; 真实元素"}]},{"t":"heading","d":2,"p":{"lines":[11,12]},"v":"外层mount","c":[{"t":"ordered_list","d":3,"p":{"lines":[16,22],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[16,17],"index":1},"v":"1. 获取当前元素"},{"t":"list_item","d":4,"p":{"lines":[17,18],"index":2},"v":"2. render函数获取","c":[{"t":"list_item","d":6,"p":{"lines":[18,19],"index":1},"v":"1. template模板获取"},{"t":"list_item","d":6,"p":{"lines":[19,20],"index":2},"v":"2. 通过模板获取render"}]},{"t":"list_item","d":4,"p":{"lines":[20,21],"index":3},"v":"3. 执行公共mount"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 公共mount备份</span>\n<span class=\"token keyword\">const</span> mount <span class=\"token operator\">=</span> <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">$mount</span>\n<span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$mount</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> hydrating</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 获取当前元素</span>\n    el <span class=\"token operator\">=</span> el <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 对于body和documentElement直接返回</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>el <span class=\"token operator\">===</span> <span class=\"token dom variable\">document</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">body</span> <span class=\"token operator\">||</span> el <span class=\"token operator\">===</span> <span class=\"token dom variable\">document</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">documentElement</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">this</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// render函数获取</span>\n    <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>options<span class=\"token punctuation\">.</span><span class=\"token property-access\">render</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 模板获取</span>\n        <span class=\"token keyword\">let</span> template <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span><span class=\"token property-access\">template</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> template <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">charAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'#'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    template <span class=\"token operator\">=</span> <span class=\"token function\">idToTemplate</span><span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">.</span><span class=\"token property-access\">nodeType</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                template <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token property-access\">innerHTML</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">this</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">else</span> <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            template <span class=\"token operator\">=</span> <span class=\"token function\">getOuterHTML</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 通过模板获取render</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n                render<span class=\"token punctuation\">,</span>\n                staticRenderFns\n            <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">compileToFunctions</span><span class=\"token punctuation\">(</span>template<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token literal-property property\">outputSourceRange</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span><span class=\"token property-access\">env</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">,</span>\n                shouldDecodeNewlines<span class=\"token punctuation\">,</span>\n                shouldDecodeNewlinesForHref<span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">delimiters</span><span class=\"token operator\">:</span> options<span class=\"token punctuation\">.</span><span class=\"token property-access\">delimiters</span><span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">comments</span><span class=\"token operator\">:</span> options<span class=\"token punctuation\">.</span><span class=\"token property-access\">comments</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n            options<span class=\"token punctuation\">.</span><span class=\"token property-access\">render</span> <span class=\"token operator\">=</span> render\n            options<span class=\"token punctuation\">.</span><span class=\"token property-access\">staticRenderFns</span> <span class=\"token operator\">=</span> staticRenderFns\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 执行公共mount</span>\n    <span class=\"token keyword control-flow\">return</span> mount<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> el<span class=\"token punctuation\">,</span> hydrating<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"heading","d":3,"p":{"lines":[71,72]},"v":"render、template和el优先级：render &gt; template &gt; el"}]},{"t":"heading","d":2,"p":{"lines":[73,74]},"v":"内部mount","c":[{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 设置__patch__</span>\n<span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__patch__</span> <span class=\"token operator\">=</span> inBrowser <span class=\"token operator\">?</span> patch <span class=\"token operator\">:</span> noop\n\n<span class=\"token comment\">// 公共的mount方法</span>\n<span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$mount</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">el<span class=\"token punctuation\">,</span> hydrating</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 获取元素</span>\n    el <span class=\"token operator\">=</span> el <span class=\"token operator\">&amp;&amp;</span> inBrowser <span class=\"token operator\">?</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword nil\">undefined</span>\n    <span class=\"token comment\">// 组件挂载</span>\n    <span class=\"token keyword control-flow\">return</span> <span class=\"token function\">mountComponent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> el<span class=\"token punctuation\">,</span> hydrating<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"heading","d":3,"p":{"lines":[90,91]},"v":"mountComponent","c":[{"t":"ordered_list","d":4,"p":{"lines":[92,96],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[92,93],"index":1},"v":"1. 没有render则渲染空节点"},{"t":"list_item","d":5,"p":{"lines":[93,94],"index":2},"v":"2. 创建updateComponent负责组件首次渲染和后续更新"},{"t":"list_item","d":5,"p":{"lines":[94,95],"index":3},"v":"3. 创建组件渲染Watcher，即一个vue的实例只有一个渲染watcher"}]},{"t":"fence","d":4,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">mountComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">vm<span class=\"token punctuation\">,</span> el<span class=\"token punctuation\">,</span> hydrating</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$el</span> <span class=\"token operator\">=</span> el\n    <span class=\"token comment\">// 没有render则渲染空节点</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">render</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">render</span> <span class=\"token operator\">=</span> createEmptyVNode\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">callHook</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token string\">'beforeMount'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// updateComponent负责组件首次渲染和后续更新</span>\n    <span class=\"token keyword\">let</span> updateComponent\n    <span class=\"token function-variable function\">updateComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">_update</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">_render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hydrating<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 创建组件渲染Watcher，即一个vue的实例只有一个渲染watcher</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Watcher</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> updateComponent<span class=\"token punctuation\">,</span> noop<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isMounted</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isDestroyed</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">callHook</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token string\">'beforeUpdate'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">/* isRenderWatcher */</span> <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 非服务端渲染</span>\n    hydrating <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">$vnode</span> <span class=\"token operator\">==</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        vm<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isMounted</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n        <span class=\"token function\">callHook</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token string\">'mounted'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword control-flow\">return</span> vm\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"ordered_list","d":4,"p":{"lines":[127,131],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[127,128],"index":1},"v":"1. updateComponent中调用了在构造函数时添加的_render和_update，这个方法就是Vue处理模板编译，更新和挂载的核心"},{"t":"list_item","d":5,"p":{"lines":[128,129],"index":2},"v":"2. _render在renderMixin时设置到实例上，负责将生成的render执行获取vnode"},{"t":"list_item","d":5,"p":{"lines":[129,130],"index":3},"v":"3. _update在lifecycleMixin时设置到实例上，负责执行<strong>patch</strong>方法，将vnode执行挂载"}]},{"t":"fence","d":4,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">updateComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">_update</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">_render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> hydrating<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]}]})</script>
</body>
</html>
