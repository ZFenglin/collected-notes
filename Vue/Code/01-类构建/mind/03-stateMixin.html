<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"stateMixin","c":[{"t":"fence","d":2,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">stateMixin</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token maybe-class-name\">Vue</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// $data和$props设置</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'$data'</span><span class=\"token punctuation\">,</span> dataDef<span class=\"token punctuation\">)</span>\n    <span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'$props'</span><span class=\"token punctuation\">,</span> propsDef<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// $set和$delete设置</span>\n    <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">$set</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">set</span>\n    <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">$</span><span class=\"token keyword\">delete</span> <span class=\"token operator\">=</span> del\n    <span class=\"token comment\">// $watch设置</span>\n    <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$watch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">expOrFn<span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"heading","d":2,"p":{"lines":[18,19]},"v":"<code>$data</code> 和 <code>$props</code> 设置","c":[{"t":"ordered_list","d":3,"p":{"lines":[20,23],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[20,21],"index":1},"v":"1. 简单将this._data和this._props封装成get"},{"t":"list_item","d":4,"p":{"lines":[21,22],"index":2},"v":"2. 将get定义到Vue.prototype上"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> dataDef <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\ndataDef<span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">get</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">_data</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> propsDef <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\npropsDef<span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">get</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">_props</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'$data'</span><span class=\"token punctuation\">,</span> dataDef<span class=\"token punctuation\">)</span>\n<span class=\"token known-class-name class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'$props'</span><span class=\"token punctuation\">,</span> propsDef<span class=\"token punctuation\">)</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[36,37]},"v":"<code>$set</code> 原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[38,44],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[38,39],"index":1},"v":"1. 如果是数组，则直接执行splice方法处理"},{"t":"list_item","d":4,"p":{"lines":[39,40],"index":2},"v":"2. 如果是对象","c":[{"t":"list_item","d":6,"p":{"lines":[40,41],"index":1},"v":"1. target上存在key，直接赋值"},{"t":"list_item","d":6,"p":{"lines":[41,42],"index":2},"v":"2. target不是响应式，直接赋值"},{"t":"list_item","d":6,"p":{"lines":[42,43],"index":3},"v":"3. 否则使用defineReactive定义新值至ob.value，并通知更新"}]}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果是数组，则直接执行splice方法处理</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">isArray</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isValidArrayIndex</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        target<span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span> <span class=\"token operator\">=</span> <span class=\"token known-class-name class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">max</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n        target<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">splice</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword control-flow\">return</span> val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 如果为对象</span>\n    <span class=\"token comment\">// 1. key存在，更新值</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token keyword\">in</span> target <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">in</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        target<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> val\n        <span class=\"token keyword control-flow\">return</span> val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> ob <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span>\n    <span class=\"token comment\">// 2. 如果修改是vue实例，则报错跳过</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isVue</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>ob <span class=\"token operator\">&amp;&amp;</span> ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">vmCount</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span> val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 3. 如果不是响应式对象，直接赋值</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ob<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        target<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> val\n        <span class=\"token keyword control-flow\">return</span> val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 4. 定义新响应式对象</span>\n    <span class=\"token function\">defineReactive</span><span class=\"token punctuation\">(</span>ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">value</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span>\n    ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">dep</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">notify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword control-flow\">return</span> val\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[75,76]},"v":"<code>$delete</code> 原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[77,81],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[77,78],"index":1},"v":"1. 如果是数组，则直接执行splice方法处理"},{"t":"list_item","d":4,"p":{"lines":[78,79],"index":2},"v":"2. 如果是对象，先过滤异常和不存在情况"},{"t":"list_item","d":4,"p":{"lines":[79,80],"index":3},"v":"3. 否则使用delete删除属性，并通知更新"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword module\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">del</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果是数组，则直接执行splice方法处理</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">isArray</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isValidArrayIndex</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        target<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">splice</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 如果为对象</span>\n    <span class=\"token keyword\">const</span> ob <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">__ob__</span>\n    <span class=\"token comment\">// 1. 如果修改是vue实例，则报错跳过</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span><span class=\"token property-access\">_isVue</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>ob <span class=\"token operator\">&amp;&amp;</span> ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">vmCount</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 2. 不存在对应key值，直接返回</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">hasOwn</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 3. delete删除属性，并触发更新</span>\n    <span class=\"token keyword\">delete</span> target<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ob<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span>\n    <span class=\"token punctuation\">}</span>\n    ob<span class=\"token punctuation\">.</span><span class=\"token property-access\">dep</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">notify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[107,108]},"v":"$watch原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[109,112],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[109,110],"index":1},"v":"1. 创建对应Watcher的实例"},{"t":"list_item","d":4,"p":{"lines":[110,111],"index":2},"v":"2. 同时返回对应watcher实例的销毁方法unwatchFn"}]},{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Vue</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">$watch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">expOrFn<span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> vm <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n    <span class=\"token comment\">// 如果回调为空，则直接创建默认Watcher</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isPlainObject</span><span class=\"token punctuation\">(</span>cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword control-flow\">return</span> <span class=\"token function\">createWatcher</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> expOrFn<span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 用户自定义watcher创建</span>\n    options <span class=\"token operator\">=</span> options <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    options<span class=\"token punctuation\">.</span><span class=\"token property-access\">user</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">const</span> watcher <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Watcher</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> expOrFn<span class=\"token punctuation\">,</span> cb<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 如果immediate，则立即执行一次</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span><span class=\"token property-access\">immediate</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> info <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">callback for immediate watcher \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>watcher<span class=\"token punctuation\">.</span><span class=\"token property-access\">expression</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span>\n        <span class=\"token function\">pushTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">invokeWithErrorHandling</span><span class=\"token punctuation\">(</span>cb<span class=\"token punctuation\">,</span> vm<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>watcher<span class=\"token punctuation\">.</span><span class=\"token property-access\">value</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> vm<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">popTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 返回清除当前watcher方法</span>\n    <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">unwatchFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        watcher<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">teardown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]})</script>
</body>
</html>
