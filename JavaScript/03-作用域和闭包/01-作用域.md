# 作用域

[作用域-思维导图](./mind/01-作用域.html)

程序的函数执行时，程序如何获取变量

所以要一套设计良好的规则来存储变量，并且之后可以方便地找到这些变量，这套规则被称为作用域

### 作用域的作用

1. 让内部的作用域可以访问到外部的变量
2. 保证执行环境的所有变量有序访问
   1. 变量合法使用范围
   2. 让变量不会外泄和暴露

## 编译原理

将 JavaScript 归类为“动态”或“解释执行”语言，但事实上它是一门编译语言

### 传统编译语言执行前步骤

1. 分词/词法分析（Tokenizing/Lexing）：由字符组成的字符串分解成（对编程语言来说）有意义的代码块
2. 解析/语法分析（Parsing）：将词法单元流（数组）转换成一个由元素逐级嵌套所组成的代表了程序语法结构的树（AST）
3. 代码生成：将 AST 转换为可执行代码

### JavaScript执行前步骤

而JavaScript的编译不是发生在构建之前，而是在执行前的几微秒

1. 遇到变量声明，编译器会询问作用域是否已经有一个该名称的变量存在于同一个作用域的集合中
   1. 如果是，编译器会忽略该声明，继续进行编译
   2. 否则它会要求作用域在当前作用域的集合中声明一个新的变量
2. 接下来编译器会为引擎生成运行时所需的代码，当处理变量赋值操作。引擎运行时会首先询问作用域，在当前的作用域集合中是否存在对应变量
   1. 如果是，引擎就会使用这个变量
   2. 如果否，引擎会继续向上查找该变量

即首先编译器会在当前作用域中声明一个变量（如果之前没有声明过），然后在运行时引擎会在作用域中查找该变量，如果能够找到就会对它赋值

## 作用域分类

所有作用域的基础就是一个全局作用域

按照声明的方式不同，分为函数作用域和块级作用域

### 全局作用域

1. 全局作用域是全局有效的
2. 但是过多的全局作用域变量会污染空间，出现命名冲突，利用函数作用域将变量包裹起来，例如Jquery

#### 创建方式

1. 最外层的函数或最外层函数外部定义的变量
2. 未通过var，let或const定义的变量

### 函数作用域

1. 有效范围仅限当前声明的函数内部

#### 创建方式

1. 函数内部的var定义变量
2. 或者let或const位于函数顶层定义的变量

### 块级作用域

1. 代码块就是由{}包裹的代码范围
2. 块级作用域仅限代码块中的变量有效

#### 创建方式

1. 在代码块中使用let或const声明的变量具有块级作用域

## 作用域链

通过编译原理可以了解到，在编译的过程中如果没有找到对应的变量，则会向上寻找

### 自由变量

1. 当前为使用var，let和const声明而直接使用的变量
2. 而自由变量不断向上寻找对应变量的过程就是作用域链

### 查找方式

1. 自由变量会首先在当前作用域寻找，如果没有找到则会向上级作用域寻找，直到找到全局作用域
2. 在多层的嵌套作用域中可以定义同名的标识符，这叫作“遮蔽效应”（内部的标识符“遮蔽”了外部的标识符）
3. 在所有嵌套的作用域中遍寻不到所需的变量，引擎就会抛出 ReferenceError异常
