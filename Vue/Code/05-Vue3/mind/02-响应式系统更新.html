<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"响应式更新","c":[{"t":"heading","d":2,"p":{"lines":[2,3]},"v":"三种响应式实现原理","c":[{"t":"ordered_list","d":3,"p":{"lines":[6,10],"start":1},"v":"","c":[{"t":"list_item","d":4,"p":{"lines":[6,7],"index":1},"v":"1. defineProperty（Vue2）"},{"t":"list_item","d":4,"p":{"lines":[7,8],"index":2},"v":"2. Proxy（Vue3 reactive）"},{"t":"list_item","d":4,"p":{"lines":[8,9],"index":3},"v":"3. value setter（Vue3 ref）"}]},{"t":"heading","d":3,"p":{"lines":[12,13]},"v":"采用Proxy的原因","c":[{"t":"heading","d":4,"p":{"lines":[14,15]},"v":"defineProperty缺陷","c":[{"t":"list_item","d":6,"p":{"lines":[16,17],"index":1},"v":"1. 添加或删除对象的属性时，Vue检测不到"},{"t":"list_item","d":6,"p":{"lines":[17,18],"index":2},"v":"2. 无法监控到数组下标和长度的变化"}]},{"t":"heading","d":4,"p":{"lines":[21,22]},"v":"Proxy优势","c":[{"t":"list_item","d":6,"p":{"lines":[23,24],"index":1},"v":"1. 用于定义基本操作的自定义行为（如属性查找，赋值，枚举，函数调用等）"},{"t":"list_item","d":6,"p":{"lines":[24,25],"index":2},"v":"2. Proxy直接代理整个对象而非对象属性，只需要代理一层就可以监听所有属性"},{"t":"list_item","d":6,"p":{"lines":[25,26],"index":3},"v":"3. Proxy可以监听数组的变化"}]},{"t":"heading","d":4,"p":{"lines":[27,28]},"v":"采用的原因","c":[{"t":"list_item","d":6,"p":{"lines":[29,30],"index":1},"v":"1. 不需用使用$set/delete触发响应式"},{"t":"list_item","d":6,"p":{"lines":[30,31],"index":2},"v":"2. 全方位的数组变化检测，消除了Vue2无效的边界情况"},{"t":"list_item","d":6,"p":{"lines":[31,32],"index":3},"v":"3. 支持 Map，Set，WeakMap和WeakSet"}]}]}]},{"t":"heading","d":2,"p":{"lines":[33,34]},"v":"响应式应用","c":[{"t":"fence","d":3,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 将data自动存放到本地localStorage，并实时监听更新</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">useStorage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> value <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">parse</span><span class=\"token punctuation\">(</span><span class=\"token dom variable\">localStorage</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">watchEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token dom variable\">localStorage</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">setItem</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token known-class-name class-name\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token property-access\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword control-flow\">return</span> data\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":2,"p":{"lines":[50,51]},"v":"手写响应式","c":[{"t":"heading","d":3,"p":{"lines":[52,53]},"v":"简单案例","c":[{"t":"fence","d":4,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    effect<span class=\"token punctuation\">,</span>\n    reactive\n<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@vue/reactivity'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> dummy\n<span class=\"token keyword\">const</span> counter <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">num1</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">num2</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    dummy <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">.</span><span class=\"token property-access\">num1</span> <span class=\"token operator\">+</span> counter<span class=\"token punctuation\">.</span><span class=\"token property-access\">num2</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span>dummy<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n    counter<span class=\"token punctuation\">.</span><span class=\"token property-access\">num1</span><span class=\"token operator\">++</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"},{"t":"ordered_list","d":4,"p":{"lines":[77,81],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[77,78],"index":1},"v":"1. effect中获取counter.num1和counter.num2的时候，就会触发counter的get拦截函数"},{"t":"list_item","d":5,"p":{"lines":[78,79],"index":2},"v":"2. get函数，会把当前的effect函数注册到一个全局的依赖地图中去"},{"t":"list_item","d":5,"p":{"lines":[79,80],"index":3},"v":"3. 当counter.num1变动时，就会触发set拦截函数，去依赖地图中找到注册的effect函数，然后执行"}]}]},{"t":"heading","d":3,"p":{"lines":[83,84]},"v":"reactive","c":[{"t":"ordered_list","d":4,"p":{"lines":[85,89],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[85,86],"index":1},"v":"1. reactive只处理对象"},{"t":"list_item","d":5,"p":{"lines":[86,87],"index":2},"v":"2. reactive会对对象的每一key都进行监听，包括对象里对象"},{"t":"list_item","d":5,"p":{"lines":[87,88],"index":3},"v":"3. reactive通过Proxy实现属性拦截，所以直接返回Proxy对象就行"}]},{"t":"fence","d":4,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// reactive.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> mutableHandles <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./baseHandles'</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> target <span class=\"token operator\">!==</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">reactive  </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>target<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> 必须是一个对象</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> target\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> mutableHandles<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[101,102]},"v":"mutableHandles","c":[{"t":"ordered_list","d":4,"p":{"lines":[104,107],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[104,105],"index":1},"v":"1. get中直接返回读取的数据，并且返回值是对象的话，还会嵌套执行reactive，并且调用track函数收集依赖"},{"t":"list_item","d":5,"p":{"lines":[105,106],"index":2},"v":"2. set中调用trigger函数，执行track收集的依赖"}]},{"t":"fence","d":4,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// baseHandles.ts</span>\n<span class=\"token keyword\">const</span> get <span class=\"token operator\">=</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> set <span class=\"token operator\">=</span> <span class=\"token function\">createSetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span>shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> receiver<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// target[key]和Reflect.get结果一致</span>\n        <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 调用track函数收集依赖</span>\n        <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 如果值是对象，并且不是浅层代理，则进行代理</span>\n            <span class=\"token keyword\">return</span> shallow <span class=\"token operator\">?</span> res <span class=\"token operator\">:</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createSetter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> object<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> PropertyKey<span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> receiver<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// 触发set的时候trigger进行触发依赖</span>\n        <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token string\">\"set\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> mutableHandles <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    get<span class=\"token punctuation\">,</span>\n    set<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[141,142]},"v":"依赖收集","c":[{"t":"ordered_list","d":4,"p":{"lines":[146,150],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[146,147],"index":1},"v":"1. WeackMap的key为target"},{"t":"list_item","d":5,"p":{"lines":[147,148],"index":2},"v":"2. Map的key为key"},{"t":"list_item","d":5,"p":{"lines":[148,149],"index":3},"v":"3. Set存储当前的activeEffect"}]},{"t":"fence","d":4,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// effect.ts</span>\n<span class=\"token comment\">// 存储依赖关系</span>\n<span class=\"token keyword\">const</span> targetMap<span class=\"token operator\">:</span> WeakMap<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> Map<span class=\"token operator\">&lt;</span>PropertyKey<span class=\"token punctuation\">,</span> Set<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">>>></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 全局激活的effect，类似vue2的target</span>\n<span class=\"token keyword\">let</span> activeEffect<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n</code></pre>\n"},{"t":"heading","d":4,"p":{"lines":[160,161]},"v":"track","c":[{"t":"fence","d":5,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// effect.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">track</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> PropertyKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 通过target获取depsMap</span>\n    <span class=\"token keyword\">let</span> depsMap <span class=\"token operator\">=</span> targetMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>depsMap<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        targetMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>depsMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 通过key获取set</span>\n    <span class=\"token keyword\">let</span> deps <span class=\"token operator\">=</span> depsMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>deps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        depsMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>deps <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 将当前的activeEffect收集</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>activeEffect <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>deps<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>activeEffect<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        deps<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>activeEffect<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":4,"p":{"lines":[184,185]},"v":"trigger","c":[{"t":"fence","d":5,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// effect.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> PropertyKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 通过target和key获取对应的deps</span>\n    <span class=\"token keyword\">const</span> depsMap <span class=\"token operator\">=</span> targetMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>depsMap<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n    <span class=\"token keyword\">const</span> deps <span class=\"token operator\">=</span> depsMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>deps<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n    <span class=\"token comment\">// 遍历deps执行effectFn</span>\n    deps<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>effectFn <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effectFn<span class=\"token punctuation\">.</span>scheduler<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            effectFn<span class=\"token punctuation\">.</span><span class=\"token function\">scheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">effectFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":4,"p":{"lines":[207,208]},"v":"effect","c":[{"t":"fence","d":5,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// effect.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">fn</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> options<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">effectFn</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            activeEffect <span class=\"token operator\">=</span> effectFn\n            <span class=\"token comment\">// 执行fn时，读取相关数据时，就会对effectFn进行收集</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            activeEffect <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>options<span class=\"token punctuation\">.</span>lazy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 不是懒加载，直接执行</span>\n        <span class=\"token function\">effectFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 调度时机，watchEffect会用到</span>\n    effectFn<span class=\"token punctuation\">.</span>scheduler <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>scheduler\n    <span class=\"token keyword\">return</span> effectFn\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"t":"heading","d":3,"p":{"lines":[235,236]},"v":"ref","c":[{"t":"ordered_list","d":4,"p":{"lines":[237,241],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[237,238],"index":1},"v":"1. ref直接使用get与set将传入的基本数据进行封装"},{"t":"list_item","d":5,"p":{"lines":[238,239],"index":2},"v":"2. 当前传入的值为对象时，还是会调用reactive将传入的对象封装"},{"t":"list_item","d":5,"p":{"lines":[239,240],"index":3},"v":"3. 通过传递 lazy 和 scheduler 来控制函数执行的时机，默认是同步执行"}]},{"t":"fence","d":4,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// ref.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ref</span><span class=\"token punctuation\">(</span>val<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> RefImpl <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRef</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RefImpl</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isRef</span><span class=\"token punctuation\">(</span>val<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>val <span class=\"token operator\">&amp;&amp;</span> val<span class=\"token punctuation\">.</span>_isRef<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">RefImpl</span> <span class=\"token punctuation\">{</span>\n    _isRef<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n    _val<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>val<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_isRef <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_val <span class=\"token operator\">=</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'get'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">set</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>val <span class=\"token operator\">!==</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_val <span class=\"token operator\">=</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'set'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>val<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> val\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[278,279]},"v":"computed","c":[{"t":"ordered_list","d":4,"p":{"lines":[280,283],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[280,281],"index":1},"v":"1. computed的value属性会被拦截，并且定制了effect的lazy和scheduler配置"},{"t":"list_item","d":5,"p":{"lines":[281,282],"index":2},"v":"2. computed注册的函数就不会直接执行，而是要通过scheduler函数中对_dirty属性决定是否执行"}]},{"t":"fence","d":4,"v":"<pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// computed.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">computed</span><span class=\"token punctuation\">(</span>getterOrOptions<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> get<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">;</span> set<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> getter<span class=\"token punctuation\">,</span> setter\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> getterOrOptions <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        getter <span class=\"token operator\">=</span> getterOrOptions\n        <span class=\"token function-variable function\">setter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'计算属性不能修改'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        getter <span class=\"token operator\">=</span> getterOrOptions<span class=\"token punctuation\">.</span>get\n        setter <span class=\"token operator\">=</span> getterOrOptions<span class=\"token punctuation\">.</span>set\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ComputedRefImpl</span><span class=\"token punctuation\">(</span>getter<span class=\"token punctuation\">,</span> setter<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ComputedRefImpl</span> <span class=\"token punctuation\">{</span>\n    _setter<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span>\n    effect<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span>\n    _val<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n    _dirty<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">getter</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> setter<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_setter <span class=\"token operator\">=</span> setter\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_dirty <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n        <span class=\"token comment\">// computed就是一个特殊的effect，会设置执行时机和lazy</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>effect <span class=\"token operator\">=</span> <span class=\"token function\">effect</span><span class=\"token punctuation\">(</span>getter<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            lazy<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function-variable function\">scheduler</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_dirty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_dirty <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n                    <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'set'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">get</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">track</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'get'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'value'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_dirty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_dirty <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_val <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">effect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_val\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">set</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set'</span> <span class=\"token operator\">+</span> val<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">_setter</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]}]})</script>
</body>
</html>
