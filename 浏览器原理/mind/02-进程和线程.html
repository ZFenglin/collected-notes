<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"进程和线程","c":[{"t":"heading","d":2,"p":{"lines":[2,3]},"v":"相关概念","c":[{"t":"heading","d":3,"p":{"lines":[4,5]},"v":"浏览器概念","c":[{"t":"list_item","d":5,"p":{"lines":[6,7],"index":1},"v":"1. 浏览器是多进程多线程模式","c":[{"t":"list_item","d":7,"p":{"lines":[7,8],"index":1},"v":"1. 单进程会导致某个页面出错，整个浏览器崩溃"},{"t":"list_item","d":7,"p":{"lines":[8,9],"index":2},"v":"2. 每个页面代表一个进程，chrome会将多个空白页合并到一个进程"},{"t":"list_item","d":7,"p":{"lines":[9,10],"index":3},"v":"3. 页面的进程负责管理多个线程"}]},{"t":"list_item","d":5,"p":{"lines":[10,11],"index":2},"v":"2. JS引擎的执行是单线程"}]},{"t":"heading","d":3,"p":{"lines":[12,13]},"v":"进程和线程比较","c":[{"t":"heading","d":4,"p":{"lines":[14,15]},"v":"资源","c":[{"t":"list_item","d":6,"p":{"lines":[16,17],"index":1},"v":"1. 进程是资源分配的最小单位，述了 CPU 在运行指令及加载和保存上下文所需的时间，即代表了一个程序"},{"t":"list_item","d":6,"p":{"lines":[17,18],"index":2},"v":"2. 线程是CPU调度的最小单位，描述了执行一段指令所需的时间"}]},{"t":"heading","d":4,"p":{"lines":[19,20]},"v":"组成","c":[{"t":"list_item","d":6,"p":{"lines":[21,22],"index":1},"v":"1. 进程由多线程组成，任意一线程执行出错，导致整个进程的崩溃"}]},{"t":"heading","d":4,"p":{"lines":[23,24]},"v":"通信","c":[{"t":"ordered_list","d":5,"p":{"lines":[25,28],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[25,26],"index":1},"v":"1. 进程间内容互相隔离，需要借助进程间通信"},{"t":"list_item","d":6,"p":{"lines":[26,27],"index":2},"v":"2. 多线程之间共享同一进程中的数据"}]},{"t":"heading","d":5,"p":{"lines":[28,29]},"v":"进程间通信","c":[{"t":"list_item","d":7,"p":{"lines":[30,31],"index":1},"v":"1. 管道通信：文件思想，一个进程读一个进程写"},{"t":"list_item","d":7,"p":{"lines":[31,32],"index":2},"v":"2. 消息队列通信：一个进程向队列中写入，一个进程从队列读取"},{"t":"list_item","d":7,"p":{"lines":[32,33],"index":3},"v":"3. 信号量通信：简单数字标记，通过计数表示资源是否可用"},{"t":"list_item","d":7,"p":{"lines":[33,34],"index":4},"v":"4. 共享内存通信：通过一块共享内存进行通信"}]}]},{"t":"heading","d":4,"p":{"lines":[35,36]},"v":"系统开销","c":[{"t":"list_item","d":6,"p":{"lines":[37,38],"index":1},"v":"1. 进程创建或撤销时，操作系统会分配或回收资源，开销大，资源包括内存，I/O等"},{"t":"list_item","d":6,"p":{"lines":[38,39],"index":2},"v":"2. 线程切换只需要保存和设置少量寄存器内容，不会引起进程切换，开销小"}]}]},{"t":"heading","d":3,"p":{"lines":[40,41]},"v":"死锁","c":[{"t":"heading","d":4,"p":{"lines":[42,43]},"v":"原因","c":[{"t":"list_item","d":6,"p":{"lines":[44,45],"index":1},"v":"1. 多个进程争夺同一资源的僵局"},{"t":"list_item","d":6,"p":{"lines":[45,46],"index":2},"v":"2. 原因是竞争资源，两个进程互相需要对方的正在使用的资源"}]},{"t":"heading","d":4,"p":{"lines":[47,48]},"v":"处理方式","c":[{"t":"list_item","d":6,"p":{"lines":[49,50],"index":1},"v":"1. 一次性分配全部资源"},{"t":"list_item","d":6,"p":{"lines":[50,51],"index":2},"v":"2. 可剥夺资源，当需要资源得不到时，释放自身资源"},{"t":"list_item","d":6,"p":{"lines":[51,52],"index":3},"v":"3. 资源请求增加编号，进程按顺序获取"}]}]},{"t":"heading","d":3,"p":{"lines":[53,54]},"v":"并发/并行","c":[{"t":"list_item","d":5,"p":{"lines":[55,56],"index":1},"v":"1. 并发（宏观）：多个任务不断切换执行"},{"t":"list_item","d":5,"p":{"lines":[56,57],"index":2},"v":"2. 并行（微观）：利用CPU多个核心，同时执行多个任务"}]}]},{"t":"heading","d":2,"p":{"lines":[58,59]},"v":"浏览器进程架构","c":[{"t":"heading","d":3,"p":{"lines":[62,63]},"v":"浏览器主进程（1）"},{"t":"heading","d":3,"p":{"lines":[66,67]},"v":"GPU 进程（1）"},{"t":"heading","d":3,"p":{"lines":[70,71]},"v":"网络进程（1）"},{"t":"heading","d":3,"p":{"lines":[74,75]},"v":"插件进程（n）"},{"t":"heading","d":3,"p":{"lines":[78,79]},"v":"渲染进程（n）","c":[{"t":"heading","d":4,"p":{"lines":[84,85]},"v":"GUI渲染线程（互斥）"},{"t":"heading","d":4,"p":{"lines":[88,89]},"v":"JS引擎线程（互斥）"},{"t":"heading","d":4,"p":{"lines":[94,95]},"v":"事件触发线程"},{"t":"heading","d":4,"p":{"lines":[98,99]},"v":"定时器触发线程"},{"t":"heading","d":4,"p":{"lines":[102,103]},"v":"异步http请求线程"}]}]},{"t":"heading","d":2,"p":{"lines":[106,107]},"v":"工作者线程（Web Workers）","c":[{"t":"heading","d":3,"p":{"lines":[110,111]},"v":"特点","c":[{"t":"list_item","d":5,"p":{"lines":[112,113],"index":1},"v":"1. 以实际线程实现"},{"t":"list_item","d":5,"p":{"lines":[113,114],"index":2},"v":"2. 每个工作者线程并行执行"},{"t":"list_item","d":5,"p":{"lines":[114,115],"index":3},"v":"3. 共享内存，SharedArrayBuffer的数据是多线程共享的，其他数据共享则需要复制或转移数据"},{"t":"list_item","d":5,"p":{"lines":[115,116],"index":4},"v":"4. 不一定处于当前页面进程"},{"t":"list_item","d":5,"p":{"lines":[116,117],"index":5},"v":"5. 创建和销毁的开销大，启用工作者线程应当是长期运行的服务"}]},{"t":"heading","d":3,"p":{"lines":[118,119]},"v":"类型","c":[{"t":"heading","d":4,"p":{"lines":[120,121]},"v":"专用工作者线程（Dedicated Worker）","c":[{"t":"ordered_list","d":5,"p":{"lines":[122,126],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[122,123],"index":1},"v":"1. Web Worker"},{"t":"list_item","d":6,"p":{"lines":[123,124],"index":2},"v":"2. 只能被创建它的页面使用"},{"t":"list_item","d":6,"p":{"lines":[124,125],"index":3},"v":"3. 处理页面执行线程里不合适做的任务（导致渲染和响应卡顿的任务）"}]},{"t":"heading","d":5,"p":{"lines":[126,127]},"v":"适用于以下任务","c":[{"t":"list_item","d":7,"p":{"lines":[128,129],"index":1},"v":"1. 密集计算"},{"t":"list_item","d":7,"p":{"lines":[129,130],"index":2},"v":"2. 大量数据处理"},{"t":"list_item","d":7,"p":{"lines":[130,131],"index":3},"v":"3. 文件输入和输出"}]}]},{"t":"heading","d":4,"p":{"lines":[132,133]},"v":"共享工作者线程（Shared Worker）","c":[{"t":"list_item","d":6,"p":{"lines":[134,135],"index":1},"v":"1. 类似专用工作者线程，是其扩展形式"},{"t":"list_item","d":6,"p":{"lines":[135,136],"index":2},"v":"2. 由同源的任意页面共享"}]},{"t":"heading","d":4,"p":{"lines":[137,138]},"v":"服务工作者线程（Service Worker）","c":[{"t":"list_item","d":6,"p":{"lines":[139,140],"index":1},"v":"1. 类似浏览器中代理服务器的线程，可以拦截外出请求和缓存响应，让网页在无网络环境下使用"},{"t":"list_item","d":6,"p":{"lines":[140,141],"index":2},"v":"2. 多个页面共享一个服务工作者线程"},{"t":"list_item","d":6,"p":{"lines":[141,142],"index":3},"v":"3. 用于让网页模拟原生应用程序，即渐进式Web应用 PWA（Progressive Web Apps）"}]}]},{"t":"heading","d":3,"p":{"lines":[143,144]},"v":"<a href=\"https://www.ruanyifeng.com/blog/2018/07/web-worker.html\">web worker使用（另两种只是API不同，流程差不多）</a>","c":[{"t":"heading","d":4,"p":{"lines":[145,146]},"v":"主线程","c":[{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 检测浏览器是否支持</span>\n<span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token maybe-class-name\">Worker</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword control-flow\">return</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 调用Worker()构造函数，新建一个 Worker 线程</span>\n<span class=\"token keyword\">var</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'work.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 主线程调用worker.postMessage()方法，向 Worker 发消息</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'echo'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">args</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Work'</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 主线程通过worker.onmessage指定监听函数，接收子线程发回来的消息</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Received message '</span> <span class=\"token operator\">+</span> event<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    worker<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Work done!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 主线程可以监听 Worker 是否发生错误。如果发生错误，Worker 会触发主线程的error事件</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">onerror</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'ERROR: Line '</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token property-access\">lineno</span><span class=\"token punctuation\">,</span> <span class=\"token string\">' in '</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token property-access\">filename</span><span class=\"token punctuation\">,</span> <span class=\"token string\">': '</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token property-access\">message</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 或者</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Worker 完成任务以后，主线程就可以把它关掉</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"}]},{"t":"heading","d":4,"p":{"lines":[196,197]},"v":"工作者线程","c":[{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 注册监听</span>\nself<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    self<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'You said: '</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// self代表子线程自身，即子线程的全局对象，等价于以下写法</span>\n<span class=\"token comment\">// 写法一</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'You said: '</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 写法二</span>\n<span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'You said: '</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Worker 内部关闭自身</span>\nself<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"},{"t":"fence","d":5,"v":"<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 脚本加载</span>\n<span class=\"token function\">importScripts</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script1.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'script2.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n"}]}]}]},{"t":"heading","d":2,"p":{"lines":[225,226]},"v":"多页签间通信","c":[{"t":"heading","d":3,"p":{"lines":[227,228]},"v":"websocket"},{"t":"heading","d":3,"p":{"lines":[231,232]},"v":"ShareWorker"},{"t":"heading","d":3,"p":{"lines":[237,238]},"v":"localStorage"},{"t":"heading","d":3,"p":{"lines":[241,242]},"v":"postMessage"}]}]})</script>
</body>
</html>
