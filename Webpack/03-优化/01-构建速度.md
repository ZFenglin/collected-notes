# 构建速度

## 缩小文件搜索范围

缩小文件搜索范围，让webpack在编译的过程中更快找到目标文件

### Loader配置优化

loader对文件的转换十分耗时，减少loader的处理

```JS
module.exports = {
    module: {
        rules: [{
            // 通过test、include和exclude配置Loader应用规则的文件，提高命中率
            test: /.jsx?$/,
            include: [
                path.resolve(__dirname, 'app')
            ],
            exclude: [
                path.resolve(__dirname, 'app/demo-files')
            ],
            use: {}
        }]
    }
}
```

### resolve配置优化

#### resolve.modules优化

```JS
module.exports = {
    resolve: {
        // 利用绝对路径指明第三方模块存储位置，减少逐级向上查找
        modules: [path.resolve(dirname, 'node_modules')]
    },
}
```

#### resolve.mainFields优化

```JS
module.exports = {
    resolve: {
        // 限制模块采用的文件，减少搜索步骤
        mainFields: ['main']
    },
}
```

#### resolve.alias优化（一般不采用）

```JS
module.exports = {
    resolve: {
        alias: {
            // 利用别名，在导入模块时直接采用模块提供的编译过的文件
            "@": path.join(__dirname, "./pages"),
            react: path.resolve(
                __dirname,
                "./node_modules/react/umd/react.production.min.js"
            ),
            "react-dom": path.resolve(
                __dirname,
                "./node_modules/react-dom/umd/react-dom.production.min.js"
            )
        },
    },
}
```

但是除非这个库整体性比较好，一般不采用，主要是会影响Tree-Sharking

#### resolve.extensions优化

resolve.extensions在导入入语句句没带文文件后缀时, webpack会自自动带上后缀后232233234

```JS
module.exports = {
    resolve: {
        // 1. 后缀列表尽可能短
        // 2. 频率高的放前面
        // 3. 引入代码时尽可能带上后缀
        extensions: ['.js', '.css', '.json', '.jsx'],
    },
}
```

### noParse忽略文件

```JS
// 配置模块相关
module.exports = {
    module: {
        // 使用noParse忽略部分没有采用模块化的文件的递归解析和处理
        noParse: [/react\.min\.js$/]
    },
}
```

## DllPlugin

Dll为动态链接库，包含为其他模块调用的函数和数据，只是优化开发速度，对生产环境没有优化

webpack内置，但是新版本不推荐使用，使用 HardSourceWebpackPlugin

### DllPlugin提速原理

1. 将网页依赖的模块抽离出来并打包到一个个单独的动态链接库中
2. 下次导入的模块存在于某个动态链接库中，则模块会从动态库中获取
3. 页面需要的所有动态链接库都需要被加载

### DllPlugin优化实现

1. DllPlugin（打包）: 用于打包出一个个单独的动态链接库文件
2. DllReferencePlugin（链接）: 用于在主要的配置文件中引入DllPlugin插件打包好的动态链接库文件

#### 打包dll

1. 创建webpack.dll.config.js文件，并设置好DllPlugin对应配置
2. package.json中添加"dev:dll": "webpack --config ./build/webpack.dll.config.js"指令，并运行命令npm run dev:dll

此时多一个dll文件夹，同时里面有单独打包的React文件，之后发开发阶段将不会再对React进行编译，节约开发时间 

1. dll文件包含大量模块的代码，并将模块放置数组中，用索引做id，暴露在全局中，使用window.xxx访问
2. Manifest.json 描述了dll.js包含那些模块，以及id和路径

#### 链接dll

1. webpack.dev.config.js文件中引入插件DllReferencePlugin，并设置好配置
2. HTML引入打包好的dll文件（add-asset-html-webpack-plugin插件可以直接设置引入）

cleanwebpack-plugin 会清除dll，记得配置cleanOnceBeforeBuildPatterns，过滤不需要删除的部分

## 构建缓存

webpack5中内置HardSourceWebpackPlugin

首次构建会在硬件中缓存，之后速度便提升，效果和DllPlugin差不多，但是使用很简单，优化70-80

```js
const HardSourceWebpackPlugin = require('hard-source-webpack-plugin')
const plugins = [
    new HardSourceWebpackPlugin()
]
```

## 多进程构建处理

将任务分解为多个子任务，任务分解给多个子进程去并发的执行，子进程处理完后再把结果发送给主进程，提升多核速度

### 任务多进程

1. HappyPack
2. thread-loader（推荐），配置起来更简单

### 代码压缩多进程

ParallelUglifyPlugin

1. webpack内置UglifyJS但是不支持多进程
2. 小项目不推荐，进程会产生开销反而降速

## IgnorePlugin

webpack内置插件，忽略第三方包指定目录，让这些指定目录不要被打包进去

```JS
module.exports = {
    plugins: [new webpack.IgnorePlugin(/^\.\/locale$/, /moment$/)]
}
```

## 减少编译代码

通过去除无用代码，或者将代码放到CDN，从而减少需要编译的代码量

1. 外部扩展externals，配置对应引入，将文件放入CDN减少编译代码
2. Tree-shaking与Scope Hoisting
